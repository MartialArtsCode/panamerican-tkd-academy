<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PTA Admin Dashboard</title>

    <!-- Config -->
    <script src="../config.js"></script>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --primary: #cc1f2b;
            --dark: #0f0f14;
            --panel: #171720;
            --border: rgba(255,255,255,0.08);
            --text: #ffffff;
            --muted: #9aa0a6;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Inter, system-ui, sans-serif;
            background: var(--dark);
            color: var(--text);
            height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header img { width: 36px; }

        .session-list {
            flex: 1;
            overflow-y: auto;
        }

        .session {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .session.active { background: rgba(204,31,43,0.15); }

        .session small { color: var(--muted); }

        /* Chat Panel */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--panel);
        }

        .chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .msg {
            margin-bottom: 14px;
            max-width: 70%;
        }

        .msg.visitor {
            background: #222;
            padding: 12px;
            border-radius: 12px 12px 12px 0;
        }

        .msg.admin {
            background: var(--primary);
            margin-left: auto;
            padding: 12px;
            border-radius: 12px 12px 0 12px;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid var(--border);
            background: var(--panel);
        }

        .chat-input input {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: none;
            color: white;
            outline: none;
        }

        .chat-input button {
            background: var(--primary);
            border: none;
            color: white;
            padding: 0 22px;
            cursor: pointer;
        }

        .empty {
            color: var(--muted);
            text-align: center;
            margin-top: 20%;
        }

        .tier-card {
            background: rgba(255,255,255,0.03);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .tier-basic { background: #666; }
        .tier-premium { background: #4caf50; }
        .tier-vip { background: #ffd700; color: #000; }
        .tier-instructor { background: #2196f3; }
        .tier-admin { background: var(--primary); }

        select.tier-select {
            padding: 8px 12px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/icon.png" alt="PTA" />
            <strong>PTA Admin</strong>
        </div>
        
        <div style="padding: 12px; border-bottom: 1px solid var(--border);">
            <button id="dashboardBtn" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                üìä Dashboard
            </button>
            <button id="manageTiersBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                üë• Manage Tiers
            </button>
            <button id="quickRepliesBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                ‚ö° Quick Replies
            </button>
            <button id="autoResponseBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                ü§ñ Auto Responses
            </button>
            <button id="exportChatsBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                üì• Export Chats
            </button>
            <button id="changePasswordBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 8px;">
                üîí Change Password
            </button>
            <button id="logoutBtn" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                üö™ Logout
            </button>
        </div>
        
        <div style="padding: 12px; border-bottom: 1px solid var(--border);">
            <input type="text" id="sessionSearch" placeholder="üîç Search sessions..." style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 13px; margin-bottom: 8px;" />
            <div style="display: flex; gap: 4px; font-size: 11px;">
                <button id="filterAll" class="filter-btn active" style="flex: 1; padding: 6px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">All</button>
                <button id="filterUnread" class="filter-btn" style="flex: 1; padding: 6px; background: rgba(255,255,255,0.05); color: white; border: none; border-radius: 4px; cursor: pointer;">Unread</button>
                <button id="filterActive" class="filter-btn" style="flex: 1; padding: 6px; background: rgba(255,255,255,0.05); color: white; border: none; border-radius: 4px; cursor: pointer;">Active</button>
            </div>
        </div>
        
        <div class="session-list" id="sessionList"></div>
    </aside>

    <!-- CHAT -->
    <main class="chat-panel">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
            <span id="chatHeader">Select a conversation</span>
            <div id="chatActions" style="display: none; gap: 8px;">
                <button id="addNoteBtn" title="Add Note" style="padding: 6px 12px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üìù</button>
                <button id="exportSessionBtn" title="Export Chat" style="padding: 6px 12px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üì•</button>
                <button id="closeSessionBtn" title="Close Session" style="padding: 6px 12px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">‚úñÔ∏è</button>
            </div>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="empty">No conversation selected</div>
        </div>
        <div class="chat-input">
            <button id="quickReplyDropdown" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 8px; margin-right: 4px;" title="Quick Replies">‚ö°</button>
            <input id="replyInput" placeholder="Type a reply‚Ä¶" />
            <button id="sendReply">Send</button>
        </div>
    </main>

    <!-- Tier Management Modal -->
    <div id="tierModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--panel); width: 90%; max-width: 900px; max-height: 90vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">Manage User Tiers</h2>
                <button id="closeTierModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div id="tiersList" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div style="text-align: center; color: var(--muted); padding: 40px;">
                    Loading users...
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--panel); width: 90%; max-width: 500px; border-radius: 12px; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">Change Password</h2>
                <button id="closePasswordModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Current Password</label>
                    <input type="password" id="currentPassword" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Password</label>
                    <input type="password" id="newPassword" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Confirm New Password</label>
                    <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px;">
                </div>
                <div id="passwordError" style="color: #f44336; margin-bottom: 16px; display: none;"></div>
                <div id="passwordSuccess" style="color: #4caf50; margin-bottom: 16px; display: none;"></div>
                <button id="savePasswordBtn" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                    Change Password
                </button>
            </div>
        </div>
    </div>

    <!-- Auto Response Modal -->
    <div id="autoResponseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h2 style="margin: 0; font-size: 20px;">Automated Responses</h2>
                <button id="closeAutoResponseModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px; overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="autoResponseEnabled" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable automated responses</span>
                    </label>
                    <small style="color: var(--muted); display: block; margin-top: 4px; margin-left: 26px;">Send instant reply when visitor sends first message</small>
                </div>
                
                <div id="autoResponseSettings" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Welcome Message</label>
                        <textarea id="autoResponseMessage" rows="4" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Thanks for reaching out! We'll respond shortly..."></textarea>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Delay (seconds)</label>
                        <input type="number" id="autoResponseDelay" min="0" max="60" value="2" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px;">
                        <small style="color: var(--muted); display: block; margin-top: 4px;">How long to wait before sending the auto-response (0-60 seconds)</small>
                    </div>
                </div>
                
                <div id="autoResponseError" style="color: #f44336; margin-bottom: 16px; display: none;"></div>
                <div id="autoResponseSuccess" style="color: #4caf50; margin-bottom: 16px; display: none;"></div>
                <button id="saveAutoResponseBtn" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Replies Modal -->
    <div id="quickRepliesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h2 style="margin: 0; font-size: 20px;">Quick Reply Templates</h2>
                <button id="closeQuickRepliesModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                <button id="addQuickReplyBtn" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; margin-bottom: 20px;">
                    <span style="font-size: 16px;">+</span> Add Quick Reply
                </button>
                
                <div id="quickRepliesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                    <!-- Quick replies will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reply Editor Modal -->
    <div id="quickReplyEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center;">
        <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h2 style="margin: 0; font-size: 20px;" id="editorModalTitle">Add Quick Reply</h2>
                <button id="closeQuickReplyEditorModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Template Name</label>
                    <input type="text" id="quickReplyName" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px;" placeholder="e.g., Class Schedule">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Message</label>
                    <textarea id="quickReplyMessage" rows="5" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Enter your message..."></textarea>
                </div>
                <div id="quickReplyError" style="color: #f44336; margin-bottom: 16px; display: none;"></div>
                <div id="quickReplySuccess" style="color: #4caf50; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px;">
                    <button id="cancelQuickReplyBtn" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        Cancel
                    </button>
                    <button id="saveQuickReplyBtn" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h2 style="margin: 0; font-size: 20px;">üìä Dashboard & Analytics</h2>
                <button id="closeDashboardModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 20px;">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Sessions</div>
                        <div id="statTotalSessions" style="font-size: 32px; font-weight: 700; color: #4caf50;">0</div>
                    </div>
                    <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 20px;">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Messages</div>
                        <div id="statTotalMessages" style="font-size: 32px; font-weight: 700; color: #2196f3;">0</div>
                    </div>
                    <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 8px; padding: 20px;">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Active Today</div>
                        <div id="statActiveToday" style="font-size: 32px; font-weight: 700; color: #ff9800;">0</div>
                    </div>
                    <div style="background: rgba(156, 39, 176, 0.1); border: 1px solid rgba(156, 39, 176, 0.3); border-radius: 8px; padding: 20px;">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Avg Response Time</div>
                        <div id="statAvgResponse" style="font-size: 32px; font-weight: 700; color: #9c27b0;">--</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 16px; font-size: 16px;">Recent Activity</h3>
                <div id="recentActivity" style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--muted); padding: 20px;">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Note Modal -->
    <div id="sessionNoteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center;">
        <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h2 style="margin: 0; font-size: 20px;">üìù Add Session Note</h2>
                <button id="closeSessionNoteModal" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Note</label>
                    <textarea id="sessionNoteText" rows="5" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Enter internal note about this session..."></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button id="cancelNoteBtn" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        Cancel
                    </button>
                    <button id="saveNoteBtn" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        Save Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTWH0fPTgj0MFWGs6+yrWBcNSqXh8sFxKAU5jdXz1Ic/CxNcr+rprFkXDkul4vO+cSoFO47W89WEPwsUXK/q6axaFw5LpeL0vnEqBTuP1vPVhD8MFF2v6umtWhcOS6Xi9L5yKgU8j9bz1YQ/DBRdr+rprVoXD0yl4vS+cioFPI/W89WEPwwUXa/q6a1aFw9MpuL0v3IqBTyP1vPVhD8MFF2v6+mtWhcPTKbi9L9yKgU8j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFPI/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6+mtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cyoFO4/W89WEPwwUXa/q6a1aFw9MpuL0v3MqBTuP1vPVhD8MFF2v6umtWhcPTKbi9L9zKgU7j9bz1YQ/DBRdr+rprVoXD0ym4vS/cw==" type="audio/wav">
    </audio>

    <script>
        // Check authentication
        const authToken = localStorage.getItem('auth_token');
        const isAdmin = localStorage.getItem('is_admin') === 'true';
        
        if (!authToken || !isAdmin) {
            alert('Admin access required. Redirecting to login...');
            window.location.href = `${BASE_PATH}/index.html`;
        }

        const socket = io(API_BASE_URL, {
            reconnection: true,
            reconnectionDelay: 1000
        });
        
        const sessionList = document.getElementById('sessionList');
        const chatBody = document.getElementById('chatBody');
        const chatHeader = document.getElementById('chatHeader');
        const replyInput = document.getElementById('replyInput');
        const sendReply = document.getElementById('sendReply');

        let activeSessionId = null;
        let sessions = {};
        let sessionElements = {};

        // Connect and authenticate as admin
        socket.on('connect', () => {
            console.log('‚úÖ Admin connected to server');
            console.log('üîë Sending identify with token:', authToken ? 'Token present' : 'No token');
            socket.emit('identify', { type: 'admin', token: authToken });
        });

        socket.on('disconnect', () => {
            console.warn('‚ùå Admin disconnected from server');
        });

        // Receive visitor messages in real-time
        socket.on('visitor-message', data => {
            console.log('üì® Visitor message received:', data);
            
            if (!sessions[data.sessionId]) {
                sessions[data.sessionId] = [];
                addSession(data.sessionId);
            }
            
            sessions[data.sessionId].push({ 
                from: 'visitor', 
                text: data.message,
                timestamp: data.timestamp || new Date().toISOString()
            });
            
            // Play notification sound and track unread
            playNotificationSound();
            incrementUnreadCount(data.sessionId);
            
            // Update session in list (show message preview)
            updateSessionPreview(data.sessionId, data.message);
            
            if (data.sessionId === activeSessionId) {
                renderMessages();
            }
        });

        // Handle visitor online status
        socket.on('visitor-online', data => {
            console.log('üë§ Visitor online:', data.sessionId);
            if (!sessions[data.sessionId]) {
                sessions[data.sessionId] = [];
                addSession(data.sessionId);
            }
        });

        socket.on('visitor-offline', data => {
            console.log('üë§ Visitor offline:', data.sessionId);
        });

        function addSession(sessionId) {
            if (sessionElements[sessionId]) return; // Already exists
            
            const div = document.createElement('div');
            div.className = 'session';
            div.setAttribute('data-session-id', sessionId);
            div.innerHTML = `
                <strong>${sessionId.substring(0, 8)}...</strong><br>
                <small class="session-preview">New conversation</small>
            `;
            div.onclick = () => selectSession(sessionId, div);
            sessionList.prepend(div);
            sessionElements[sessionId] = div;
        }

        function updateSessionPreview(sessionId, message) {
            const el = sessionElements[sessionId];
            if (el) {
                const preview = el.querySelector('.session-preview');
                if (preview) {
                    preview.textContent = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                }
            }
        }

        function selectSession(id, el) {
            activeSessionId = id;
            document.querySelectorAll('.session').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            document.querySelector('#chatHeader span').textContent = `Session: ${id.substring(0, 12)}...`;
            
            // Show chat actions
            if (chatActions) chatActions.style.display = 'flex';
            
            // Clear unread count for this session
            clearUnreadCount(id);
            
            renderMessages();
            replyInput.disabled = false;
            replyInput.focus();
        }

        // Notification sound
        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(err => console.log('Audio play prevented:', err));
                }
            } catch (error) {
                console.log('Error playing notification sound:', error);
            }
        }

        // Unread message tracking
        const unreadCounts = {};

        function clearUnreadCount(sessionId) {
            if (unreadCounts[sessionId]) {
                delete unreadCounts[sessionId];
                updateUnreadBadge();
            }
        }

        function incrementUnreadCount(sessionId) {
            if (sessionId !== activeSessionId) {
                unreadCounts[sessionId] = (unreadCounts[sessionId] || 0) + 1;
                updateUnreadBadge();
            }
        }

        function updateUnreadBadge() {
            const totalUnread = Object.values(unreadCounts).reduce((sum, count) => sum + count, 0);
            
            // Update session items with badges
            Object.keys(unreadCounts).forEach(sessionId => {
                const sessionEl = document.querySelector(`.session[data-session-id="${sessionId}"]`);
                if (sessionEl) {
                    let badge = sessionEl.querySelector('.unread-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'unread-badge';
                        badge.style.cssText = `
                            background: var(--primary);
                            color: white;
                            border-radius: 12px;
                            padding: 2px 8px;
                            font-size: 11px;
                            font-weight: 600;
                            margin-left: auto;
                        `;
                        sessionEl.appendChild(badge);
                    }
                    badge.textContent = unreadCounts[sessionId];
                }
            });

            // Remove badges for sessions with no unread
            document.querySelectorAll('.session').forEach(sessionEl => {
                const sessionId = sessionEl.getAttribute('data-session-id');
                if (!unreadCounts[sessionId]) {
                    const badge = sessionEl.querySelector('.unread-badge');
                    if (badge) badge.remove();
                }
            });

            // Update page title if there are unread messages
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) Admin Dashboard - PTA`;
            } else {
                document.title = 'Admin Dashboard - PTA';
            }
        }

        function renderMessages() {
            chatBody.innerHTML = '';
            
            if (!sessions[activeSessionId] || sessions[activeSessionId].length === 0) {
                chatBody.innerHTML = '<div class="empty">No messages yet</div>';
                return;
            }
            
            sessions[activeSessionId].forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.from}`;
                
                const textNode = document.createElement('div');
                textNode.textContent = m.text;
                div.appendChild(textNode);
                
                if (m.timestamp) {
                    const time = document.createElement('small');
                    time.style.opacity = '0.6';
                    time.style.fontSize = '11px';
                    time.style.display = 'block';
                    time.style.marginTop = '4px';
                    time.textContent = new Date(m.timestamp).toLocaleTimeString();
                    div.appendChild(time);
                }
                
                chatBody.appendChild(div);
            });
            
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function sendAdminReply() {
            const text = replyInput.value.trim();
            if (!text || !activeSessionId) return;

            const messageData = {
                sessionId: activeSessionId,
                message: text,
                timestamp: new Date().toISOString()
            };

            socket.emit('admin-response', messageData);

            sessions[activeSessionId].push({ 
                from: 'admin', 
                text,
                timestamp: messageData.timestamp
            });
            
            replyInput.value = '';
            renderMessages();
        }

        sendReply.onclick = sendAdminReply;
        
        replyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendAdminReply();
            }
        });

        // Disable input until session is selected
        replyInput.disabled = true;
        replyInput.placeholder = 'Select a conversation to reply...';

        console.log('üîò Setting up button handlers...');

        // Tier Management
        const tierModal = document.getElementById('tierModal');
        const manageTiersBtn = document.getElementById('manageTiersBtn');
        const closeTierModal = document.getElementById('closeTierModal');
        const tiersList = document.getElementById('tiersList');

        console.log('Tier elements:', { tierModal: !!tierModal, manageTiersBtn: !!manageTiersBtn });

        if (manageTiersBtn) {
            manageTiersBtn.onclick = () => {
                console.log('üéØ Manage Tiers button clicked');
                tierModal.style.display = 'flex';
                loadUsers();
            };
        } else {
            console.error('‚ùå manageTiersBtn not found');
        }

        if (closeTierModal) {
            closeTierModal.onclick = () => {
                tierModal.style.display = 'none';
            };
        }

        // Password Change
        const passwordModal = document.getElementById('passwordModal');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const closePasswordModal = document.getElementById('closePasswordModal');
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const passwordSuccess = document.getElementById('passwordSuccess');

        console.log('Password elements:', { passwordModal: !!passwordModal, changePasswordBtn: !!changePasswordBtn });

        if (changePasswordBtn) {
            changePasswordBtn.onclick = () => {
                console.log('üéØ Change Password button clicked');
                passwordModal.style.display = 'flex';
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                passwordError.style.display = 'none';
                passwordSuccess.style.display = 'none';
            };
        } else {
            console.error('‚ùå changePasswordBtn not found');
        }

        if (closePasswordModal) {
            closePasswordModal.onclick = () => {
                passwordModal.style.display = 'none';
            };
        }

        if (savePasswordBtn) {
            savePasswordBtn.onclick = async () => {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            passwordError.style.display = 'none';
            passwordSuccess.style.display = 'none';

            if (!currentPassword || !newPassword || !confirmPassword) {
                passwordError.textContent = 'All fields are required';
                passwordError.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                passwordError.textContent = 'New passwords do not match';
                passwordError.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters';
                passwordError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (!response.ok) {
                    passwordError.textContent = data.error || 'Failed to change password';
                    passwordError.style.display = 'block';
                    return;
                }

                passwordSuccess.textContent = 'Password changed successfully!';
                passwordSuccess.style.display = 'block';
                
                setTimeout(() => {
                    passwordModal.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Error changing password:', error);
                passwordError.textContent = 'Network error. Please try again.';
                passwordError.style.display = 'block';
            }
            };
        } else {
            console.error('‚ùå savePasswordBtn not found');
        }

        // Logout
        const logoutBtn = document.getElementById('logoutBtn');
        console.log('Logout button element:', { logoutBtn: !!logoutBtn });

        if (logoutBtn) {
            logoutBtn.onclick = () => {
                console.log('üéØ Logout button clicked');
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.clear();
                    window.location.href = `${BASE_PATH}/index.html`;
                }
            };
        } else {
            console.error('‚ùå logoutBtn not found');
        }

        // Dashboard
        const dashboardModal = document.getElementById('dashboardModal');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const closeDashboardModal = document.getElementById('closeDashboardModal');

        if (dashboardBtn) {
            dashboardBtn.onclick = () => {
                dashboardModal.style.display = 'flex';
                loadDashboardStats();
            };
        }

        if (closeDashboardModal) {
            closeDashboardModal.onclick = () => {
                dashboardModal.style.display = 'none';
            };
        }

        function loadDashboardStats() {
            const totalSessions = Object.keys(sessions).length;
            let totalMessages = 0;
            let activeToday = 0;
            const today = new Date().toDateString();

            Object.values(sessions).forEach(msgs => {
                totalMessages += msgs.length;
                if (msgs.some(m => new Date(m.timestamp).toDateString() === today)) {
                    activeToday++;
                }
            });

            document.getElementById('statTotalSessions').textContent = totalSessions;
            document.getElementById('statTotalMessages').textContent = totalMessages;
            document.getElementById('statActiveToday').textContent = activeToday;
            document.getElementById('statAvgResponse').textContent = totalSessions > 0 ? '< 2min' : '--';

            // Recent activity
            const recentActivity = document.getElementById('recentActivity');
            const allMessages = [];
            Object.entries(sessions).forEach(([sid, msgs]) => {
                msgs.forEach(m => allMessages.push({ ...m, sessionId: sid }));
            });
            allMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (allMessages.length === 0) {
                recentActivity.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No activity yet</div>';
            } else {
                recentActivity.innerHTML = allMessages.slice(0, 10).map(m => `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <strong style="font-size: 13px;">${m.sessionId.substring(0, 10)}...</strong>
                            <span style="font-size: 12px; color: var(--muted);">${new Date(m.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--muted);">${m.from === 'visitor' ? 'üë§' : 'üë®‚Äçüíº'} ${m.text.substring(0, 60)}${m.text.length > 60 ? '...' : ''}</div>
                    </div>
                `).join('');
            }
        }

        // Session Actions
        const chatActions = document.getElementById('chatActions');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const exportSessionBtn = document.getElementById('exportSessionBtn');
        const closeSessionBtn = document.getElementById('closeSessionBtn');

        if (addNoteBtn) {
            addNoteBtn.onclick = () => {
                document.getElementById('sessionNoteModal').style.display = 'flex';
            };
        }

        if (exportSessionBtn) {
            exportSessionBtn.onclick = () => {
                exportCurrentSession();
            };
        }

        if (closeSessionBtn) {
            closeSessionBtn.onclick = () => {
                if (confirm('Close this session? It will be removed from the list.')) {
                    delete sessions[activeSessionId];
                    delete sessionElements[activeSessionId];
                    const sessionEl = document.querySelector(`.session[data-session-id="${activeSessionId}"]`);
                    if (sessionEl) sessionEl.remove();
                    activeSessionId = null;
                    chatActions.style.display = 'none';
                    document.getElementById('chatHeader').textContent = 'Select a conversation';
                    chatBody.innerHTML = '<div class="empty">No conversation selected</div>';
                    replyInput.disabled = true;
                }
            };
        }

        // Session Note Modal
        const sessionNoteModal = document.getElementById('sessionNoteModal');
        const closeSessionNoteModal = document.getElementById('closeSessionNoteModal');
        const cancelNoteBtn = document.getElementById('cancelNoteBtn');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const sessionNoteText = document.getElementById('sessionNoteText');

        if (closeSessionNoteModal) {
            closeSessionNoteModal.onclick = () => {
                sessionNoteModal.style.display = 'none';
                sessionNoteText.value = '';
            };
        }

        if (cancelNoteBtn) {
            cancelNoteBtn.onclick = () => {
                sessionNoteModal.style.display = 'none';
                sessionNoteText.value = '';
            };
        }

        if (saveNoteBtn) {
            saveNoteBtn.onclick = () => {
                const note = sessionNoteText.value.trim();
                if (note && activeSessionId) {
                    if (!sessions[activeSessionId]) sessions[activeSessionId] = [];
                    sessions[activeSessionId].push({
                        from: 'note',
                        text: `üìù Note: ${note}`,
                        timestamp: new Date().toISOString()
                    });
                    renderMessages();
                    sessionNoteModal.style.display = 'none';
                    sessionNoteText.value = '';
                }
            };
        }

        // Export Chats
        const exportChatsBtn = document.getElementById('exportChatsBtn');
        if (exportChatsBtn) {
            exportChatsBtn.onclick = () => {
                exportAllChats();
            };
        }

        function exportCurrentSession() {
            if (!activeSessionId || !sessions[activeSessionId]) return;
            const csv = generateCSV(activeSessionId, sessions[activeSessionId]);
            downloadCSV(csv, `chat-${activeSessionId.substring(0, 8)}-${Date.now()}.csv`);
        }

        function exportAllChats() {
            const allData = [];
            Object.entries(sessions).forEach(([sid, msgs]) => {
                msgs.forEach(m => allData.push({ sessionId: sid, ...m }));
            });
            const csv = 'Session ID,From,Message,Timestamp\n' + allData.map(d => 
                `"${d.sessionId}","${d.from}","${d.text.replace(/"/g, '""')}","${d.timestamp}"`
            ).join('\n');
            downloadCSV(csv, `all-chats-${Date.now()}.csv`);
        }

        function generateCSV(sessionId, messages) {
            const header = 'Session ID,From,Message,Timestamp\n';
            const rows = messages.map(m => 
                `"${sessionId}","${m.from}","${m.text.replace(/"/g, '""')}","${m.timestamp}"`
            ).join('\n');
            return header + rows;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Session Search and Filter
        const sessionSearch = document.getElementById('sessionSearch');
        const filterAll = document.getElementById('filterAll');
        const filterUnread = document.getElementById('filterUnread');
        const filterActive = document.getElementById('filterActive');

        let currentFilter = 'all';

        if (sessionSearch) {
            sessionSearch.oninput = () => filterSessions();
        }

        if (filterAll) {
            filterAll.onclick = () => {
                currentFilter = 'all';
                updateFilterButtons();
                filterSessions();
            };
        }

        if (filterUnread) {
            filterUnread.onclick = () => {
                currentFilter = 'unread';
                updateFilterButtons();
                filterSessions();
            };
        }

        if (filterActive) {
            filterActive.onclick = () => {
                currentFilter = 'active';
                updateFilterButtons();
                filterSessions();
            };
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.05)';
            });
            if (currentFilter === 'all') filterAll.style.background = 'var(--primary)';
            if (currentFilter === 'unread') filterUnread.style.background = 'var(--primary)';
            if (currentFilter === 'active') filterActive.style.background = 'var(--primary)';
        }

        function filterSessions() {
            const searchTerm = sessionSearch ? sessionSearch.value.toLowerCase() : '';
            const today = new Date().toDateString();

            document.querySelectorAll('.session').forEach(sessionEl => {
                const sessionId = sessionEl.getAttribute('data-session-id');
                const text = sessionEl.textContent.toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                
                let matchesFilter = true;
                if (currentFilter === 'unread') {
                    matchesFilter = unreadCounts[sessionId] > 0;
                } else if (currentFilter === 'active') {
                    const msgs = sessions[sessionId] || [];
                    matchesFilter = msgs.some(m => new Date(m.timestamp).toDateString() === today);
                }

                sessionEl.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }

        // Quick Replies Management
        let quickReplies = [];
        let editingQuickReplyId = null;

        const quickRepliesModal = document.getElementById('quickRepliesModal');
        const quickRepliesBtn = document.getElementById('quickRepliesBtn');
        const closeQuickRepliesModal = document.getElementById('closeQuickRepliesModal');
        const quickRepliesList = document.getElementById('quickRepliesList');
        const addQuickReplyBtn = document.getElementById('addQuickReplyBtn');
        
        const quickReplyEditorModal = document.getElementById('quickReplyEditorModal');
        const closeQuickReplyEditorModal = document.getElementById('closeQuickReplyEditorModal');
        const quickReplyName = document.getElementById('quickReplyName');
        const quickReplyMessage = document.getElementById('quickReplyMessage');
        const saveQuickReplyBtn = document.getElementById('saveQuickReplyBtn');
        const cancelQuickReplyBtn = document.getElementById('cancelQuickReplyBtn');
        const quickReplyError = document.getElementById('quickReplyError');
        const quickReplySuccess = document.getElementById('quickReplySuccess');
        const editorModalTitle = document.getElementById('editorModalTitle');

        const quickReplyDropdown = document.getElementById('quickReplyDropdown');

        console.log('Quick Replies elements:', { quickRepliesModal: !!quickRepliesModal, quickRepliesBtn: !!quickRepliesBtn });

        if (quickRepliesBtn) {
            quickRepliesBtn.onclick = () => {
                console.log('üéØ Quick Replies button clicked');
                quickRepliesModal.style.display = 'flex';
                loadQuickReplies();
            };
        } else {
            console.error('‚ùå quickRepliesBtn not found');
        }

        closeQuickRepliesModal.onclick = () => {
            quickRepliesModal.style.display = 'none';
        };

        closeQuickReplyEditorModal.onclick = () => {
            quickReplyEditorModal.style.display = 'none';
            resetQuickReplyEditor();
        };

        cancelQuickReplyBtn.onclick = () => {
            quickReplyEditorModal.style.display = 'none';
            resetQuickReplyEditor();
        };

        addQuickReplyBtn.onclick = () => {
            editingQuickReplyId = null;
            editorModalTitle.textContent = 'Add Quick Reply';
            quickReplyEditorModal.style.display = 'flex';
        };

        saveQuickReplyBtn.onclick = async () => {
            const name = quickReplyName.value.trim();
            const message = quickReplyMessage.value.trim();

            quickReplyError.style.display = 'none';
            quickReplySuccess.style.display = 'none';

            if (!name || !message) {
                quickReplyError.textContent = 'Please fill in all fields';
                quickReplyError.style.display = 'block';
                return;
            }

            try {
                const url = editingQuickReplyId 
                    ? `${API_BASE_URL}/api/admin/templates/${editingQuickReplyId}`
                    : `${API_BASE_URL}/api/admin/templates`;
                
                const method = editingQuickReplyId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, message })
                });

                const data = await response.json();

                if (!response.ok) {
                    quickReplyError.textContent = data.error || 'Failed to save template';
                    quickReplyError.style.display = 'block';
                    return;
                }

                quickReplySuccess.textContent = editingQuickReplyId ? 'Template updated!' : 'Template added!';
                quickReplySuccess.style.display = 'block';

                setTimeout(() => {
                    quickReplyEditorModal.style.display = 'none';
                    resetQuickReplyEditor();
                    loadQuickReplies();
                }, 1000);

            } catch (error) {
                console.error('Error saving template:', error);
                quickReplyError.textContent = 'Network error. Please try again.';
                quickReplyError.style.display = 'block';
            }
        };

        async function loadQuickReplies() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/templates`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load templates');

                const data = await response.json();
                quickReplies = data.templates || [];
                renderQuickReplies();
            } catch (error) {
                console.error('Error loading quick replies:', error);
                quickRepliesList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">Error loading templates</div>';
            }
        }

        function renderQuickReplies() {
            if (quickReplies.length === 0) {
                quickRepliesList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">No quick replies yet. Create one to get started!</div>';
                return;
            }

            quickRepliesList.innerHTML = quickReplies.map(template => `
                <div style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; padding: 16px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <h4 style="margin: 0; font-size: 14px; font-weight: 600;">${template.name}</h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editQuickReply('${template.id}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 14px;" title="Edit">‚úèÔ∏è</button>
                            <button onclick="deleteQuickReply('${template.id}')" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 14px;" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: var(--muted); line-height: 1.5; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">${template.message}</p>
                    <button onclick="useQuickReply('${template.id}')" style="margin-top: 12px; width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">
                        Use Template
                    </button>
                </div>
            `).join('');
        }

        window.editQuickReply = (id) => {
            const template = quickReplies.find(t => t.id === id);
            if (!template) return;

            editingQuickReplyId = id;
            editorModalTitle.textContent = 'Edit Quick Reply';
            quickReplyName.value = template.name;
            quickReplyMessage.value = template.message;
            quickReplyEditorModal.style.display = 'flex';
        };

        window.deleteQuickReply = async (id) => {
            if (!confirm('Are you sure you want to delete this template?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/templates/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete template');

                loadQuickReplies();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Failed to delete template. Please try again.');
            }
        };

        window.useQuickReply = (id) => {
            const template = quickReplies.find(t => t.id === id);
            if (!template) return;

            replyInput.value = template.message;
            quickRepliesModal.style.display = 'none';
            replyInput.focus();
        };

        // Quick reply dropdown in chat
        quickReplyDropdown.onclick = async () => {
            if (quickReplies.length === 0) {
                await loadQuickReplies();
            }

            if (quickReplies.length === 0) {
                alert('No quick replies available. Create some in the Quick Replies menu!');
                return;
            }

            // Create dropdown menu
            const existingDropdown = document.getElementById('quickReplyDropdownMenu');
            if (existingDropdown) {
                existingDropdown.remove();
                return;
            }

            const dropdown = document.createElement('div');
            dropdown.id = 'quickReplyDropdownMenu';
            dropdown.style.cssText = `
                position: absolute;
                bottom: 100%;
                left: 0;
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 8px;
                margin-bottom: 8px;
                max-height: 300px;
                overflow-y: auto;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 100;
                min-width: 250px;
            `;

            dropdown.innerHTML = quickReplies.map(template => `
                <div onclick="selectQuickReply('${template.id}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${template.name}</div>
                    <div style="font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${template.message}</div>
                </div>
            `).join('');

            document.querySelector('.reply-input-container').style.position = 'relative';
            document.querySelector('.reply-input-container').appendChild(dropdown);

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== quickReplyDropdown) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        };

        window.selectQuickReply = (id) => {
            const template = quickReplies.find(t => t.id === id);
            if (template) {
                replyInput.value = template.message;
                const dropdown = document.getElementById('quickReplyDropdownMenu');
                if (dropdown) dropdown.remove();
                replyInput.focus();
            }
        };

        function resetQuickReplyEditor() {
            quickReplyName.value = '';
            quickReplyMessage.value = '';
            quickReplyError.style.display = 'none';
            quickReplySuccess.style.display = 'none';
            editingQuickReplyId = null;
        }

        // Auto Response Management
        const autoResponseModal = document.getElementById('autoResponseModal');
        const autoResponseBtn = document.getElementById('autoResponseBtn');
        const closeAutoResponseModal = document.getElementById('closeAutoResponseModal');
        const autoResponseEnabled = document.getElementById('autoResponseEnabled');
        const autoResponseSettings = document.getElementById('autoResponseSettings');
        const autoResponseMessage = document.getElementById('autoResponseMessage');
        const autoResponseDelay = document.getElementById('autoResponseDelay');
        const saveAutoResponseBtn = document.getElementById('saveAutoResponseBtn');
        const autoResponseError = document.getElementById('autoResponseError');
        const autoResponseSuccess = document.getElementById('autoResponseSuccess');

        console.log('Auto Response elements:', { autoResponseModal: !!autoResponseModal, autoResponseBtn: !!autoResponseBtn });

        if (autoResponseBtn) {
            autoResponseBtn.onclick = async () => {
                console.log('üéØ Auto Response button clicked');
                autoResponseModal.style.display = 'flex';
                await loadAutoResponseSettings();
            };
        } else {
            console.error('‚ùå autoResponseBtn not found');
        }

        closeAutoResponseModal.onclick = () => {
            autoResponseModal.style.display = 'none';
        };

        autoResponseEnabled.onchange = () => {
            autoResponseSettings.style.display = autoResponseEnabled.checked ? 'block' : 'none';
        };

        saveAutoResponseBtn.onclick = async () => {
            autoResponseError.style.display = 'none';
            autoResponseSuccess.style.display = 'none';

            const settings = {
                enabled: autoResponseEnabled.checked,
                message: autoResponseMessage.value.trim(),
                delay: parseInt(autoResponseDelay.value) || 2
            };

            if (settings.enabled && !settings.message) {
                autoResponseError.textContent = 'Please enter a welcome message';
                autoResponseError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auto-response`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (!response.ok) {
                    autoResponseError.textContent = data.error || 'Failed to save settings';
                    autoResponseError.style.display = 'block';
                    return;
                }

                autoResponseSuccess.textContent = 'Settings saved successfully!';
                autoResponseSuccess.style.display = 'block';
                
                setTimeout(() => {
                    autoResponseModal.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Error saving auto-response:', error);
                autoResponseError.textContent = 'Network error. Please try again.';
                autoResponseError.style.display = 'block';
            }
        };

        async function loadAutoResponseSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auto-response`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const settings = await response.json();
                    autoResponseEnabled.checked = settings.enabled || false;
                    autoResponseMessage.value = settings.message || '';
                    autoResponseDelay.value = settings.delay || 2;
                    autoResponseSettings.style.display = settings.enabled ? 'block' : 'none';
                }
            } catch (error) {
                console.error('Error loading auto-response settings:', error);
            }
        }

        async function loadUsers() {
            try {
                tiersList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">Loading users...</div>';
                
                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch users');
                
                const data = await response.json();
                renderUsers(data.users);
            } catch (error) {
                console.error('Error loading users:', error);
                tiersList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">Error loading users</div>';
            }
        }

        function renderUsers(users) {
            if (!users || users.length === 0) {
                tiersList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">No users found</div>';
                return;
            }

            tiersList.innerHTML = users.map(user => `
                <div class="tier-card">
                    <div>
                        <strong>${user.email}</strong>
                        <span class="tier-badge tier-${user.tier || 'basic'}">${(user.tier || 'basic').toUpperCase()}</span>
                        ${user.isAdmin ? '<span style="color: var(--primary); margin-left: 8px;">üëë Admin</span>' : ''}
                    </div>
                    <select class="tier-select" onchange="updateTier('${user.email}', this.value)" ${user.email === 'panamericantkd22@gmail.com' ? 'disabled' : ''}>
                        <option value="basic" ${user.tier === 'basic' ? 'selected' : ''}>Basic</option>
                        <option value="premium" ${user.tier === 'premium' ? 'selected' : ''}>Premium</option>
                        <option value="vip" ${user.tier === 'vip' ? 'selected' : ''}>VIP</option>
                        <option value="instructor" ${user.tier === 'instructor' ? 'selected' : ''}>Instructor</option>
                        <option value="admin" ${user.tier === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
            `).join('');
        }

        async function updateTier(email, newTier) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${encodeURIComponent(email)}/tier`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tier: newTier })
                });
                
                if (!response.ok) throw new Error('Failed to update tier');
                
                const data = await response.json();
                console.log('‚úÖ Tier updated:', data);
                
                // Reload users to reflect changes
                loadUsers();
            } catch (error) {
                console.error('Error updating tier:', error);
                alert('Failed to update tier. Please try again.');
            }
        }

        // Make updateTier available globally
        window.updateTier = updateTier;

