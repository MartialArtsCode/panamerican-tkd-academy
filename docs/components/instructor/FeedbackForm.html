import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Star, Send, Loader2, MessageSquare } from 'lucide-react';
import { format } from 'date-fns';

export default function FeedbackForm({ currentUser }) {
  const [selectedStudent, setSelectedStudent] = useState('');
  const [feedback, setFeedback] = useState({
    category: 'general',
    rating: 3,
    comments: '',
    strengths: '',
    areas_for_improvement: '',
  });
  const queryClient = useQueryClient();

  const { data: students = [] } = useQuery({
    queryKey: ['students'],
    queryFn: () => base44.entities.User.filter({ tier: 'student' }),
  });

  const { data: recentFeedback = [] } = useQuery({
    queryKey: ['recentFeedback'],
    queryFn: () => base44.entities.Feedback.filter(
      { instructor_email: currentUser.email },
      '-created_date',
      10
    ),
  });

  const submitMutation = useMutation({
    mutationFn: (data) => {
      const student = students.find(s => s.email === selectedStudent);
      return base44.entities.Feedback.create({
        ...data,
        student_email: selectedStudent,
        student_name: student?.full_name || selectedStudent,
        instructor_email: currentUser.email,
        instructor_name: currentUser.full_name,
        date: new Date().toISOString().split('T')[0],
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['recentFeedback'] });
      setSelectedStudent('');
      setFeedback({
        category: 'general',
        rating: 3,
        comments: '',
        strengths: '',
        areas_for_improvement: '',
      });
    },
  });

  const categoryLabels = {
    technique: 'Technique',
    discipline: 'Discipline',
    progress: 'Progress',
    attitude: 'Attitude',
    general: 'General'
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Feedback Form */}
      <Card>
        <CardHeader>
          <CardTitle>Submit Feedback</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div>
              <Label>Select Student *</Label>
              <Select value={selectedStudent} onValueChange={setSelectedStudent}>
                <SelectTrigger>
                  <SelectValue placeholder="Choose a student..." />
                </SelectTrigger>
                <SelectContent>
                  {students.map((student) => (
                    <SelectItem key={student.email} value={student.email}>
                      {student.full_name} - {student.belt}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Category *</Label>
                <Select
                  value={feedback.category}
                  onValueChange={(value) => setFeedback({ ...feedback, category: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="technique">Technique</SelectItem>
                    <SelectItem value="discipline">Discipline</SelectItem>
                    <SelectItem value="progress">Progress</SelectItem>
                    <SelectItem value="attitude">Attitude</SelectItem>
                    <SelectItem value="general">General</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Rating (1-5) *</Label>
                <div className="flex gap-1 mt-2">
                  {[1, 2, 3, 4, 5].map((rating) => (
                    <button
                      key={rating}
                      onClick={() => setFeedback({ ...feedback, rating })}
                      className="focus:outline-none"
                    >
                      <Star
                        className={`w-7 h-7 ${
                          rating <= feedback.rating
                            ? 'fill-yellow-400 text-yellow-400'
                            : 'text-gray-300'
                        }`}
                      />
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div>
              <Label>Strengths</Label>
              <Textarea
                value={feedback.strengths}
                onChange={(e) => setFeedback({ ...feedback, strengths: e.target.value })}
                placeholder="What is the student doing well?"
                rows={3}
              />
            </div>

            <div>
              <Label>Areas for Improvement</Label>
              <Textarea
                value={feedback.areas_for_improvement}
                onChange={(e) => setFeedback({ ...feedback, areas_for_improvement: e.target.value })}
                placeholder="What can the student work on?"
                rows={3}
              />
            </div>

            <div>
              <Label>Additional Comments</Label>
              <Textarea
                value={feedback.comments}
                onChange={(e) => setFeedback({ ...feedback, comments: e.target.value })}
                placeholder="General feedback..."
                rows={3}
              />
            </div>

            <Button
              onClick={() => submitMutation.mutate(feedback)}
              disabled={!selectedStudent || submitMutation.isPending}
              className="w-full bg-gradient-to-r from-purple-600 to-purple-700"
            >
              {submitMutation.isPending ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                <>
                  <Send className="w-4 h-4 mr-2" />
                  Submit Feedback
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Recent Feedback */}
      <Card>
        <CardHeader>
          <CardTitle>Recent Feedback</CardTitle>
        </CardHeader>
        <CardContent>
          {recentFeedback.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <MessageSquare className="w-12 h-12 mx-auto mb-3 text-gray-300" />
              <p>No feedback submitted yet</p>
            </div>
          ) : (
            <div className="space-y-4">
              {recentFeedback.map((fb) => (
                <div key={fb.id} className="p-4 bg-gradient-to-br from-purple-50 to-white rounded-xl border border-purple-100">
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <p className="font-semibold text-gray-900">{fb.student_name}</p>
                      <p className="text-xs text-gray-500">
                        {fb.date && format(new Date(fb.date), 'MMM d, yyyy')}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className="bg-purple-100 text-purple-800">
                        {categoryLabels[fb.category]}
                      </Badge>
                      <div className="flex">
                        {Array.from({ length: fb.rating }).map((_, i) => (
                          <Star key={i} className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                        ))}
                      </div>
                    </div>
                  </div>
                  {fb.comments && (
                    <p className="text-sm text-gray-700 mt-2">{fb.comments}</p>
                  )}
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}