import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Plus, Calendar, Clock, Users, Trash2, Loader2 } from 'lucide-react';
import { format } from 'date-fns';

export default function ClassScheduler({ currentUser }) {
  const [showDialog, setShowDialog] = useState(false);
  const [newClass, setNewClass] = useState({
    title: '',
    description: '',
    date: '',
    start_time: '',
    end_time: '',
    level: 'all_levels',
    max_students: 20,
    enrolled_students: []
  });
  const queryClient = useQueryClient();

  const { data: classes = [], isLoading } = useQuery({
    queryKey: ['classes'],
    queryFn: () => base44.entities.Class.filter(
      { instructor_email: currentUser.email },
      '-date'
    ),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Class.create({
      ...data,
      instructor_email: currentUser.email,
      instructor_name: currentUser.full_name,
    }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['classes'] });
      setShowDialog(false);
      setNewClass({
        title: '',
        description: '',
        date: '',
        start_time: '',
        end_time: '',
        level: 'all_levels',
        max_students: 20,
        enrolled_students: []
      });
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Class.delete(id),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['classes'] }),
  });

  const levelLabels = {
    beginner: 'Beginner',
    intermediate: 'Intermediate',
    advanced: 'Advanced',
    all_levels: 'All Levels'
  };

  return (
    <>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Class Schedule</CardTitle>
            <Dialog open={showDialog} onOpenChange={setShowDialog}>
              <DialogTrigger asChild>
                <Button className="bg-gradient-to-r from-blue-600 to-blue-700 gap-2">
                  <Plus className="w-4 h-4" />
                  Schedule Class
                </Button>
              </DialogTrigger>
              <DialogContent className="max-w-lg">
                <DialogHeader>
                  <DialogTitle>Schedule New Class</DialogTitle>
                </DialogHeader>
                <div className="space-y-4 pt-4">
                  <div>
                    <Label>Class Title *</Label>
                    <Input
                      value={newClass.title}
                      onChange={(e) => setNewClass({ ...newClass, title: e.target.value })}
                      placeholder="e.g., Advanced Sparring"
                    />
                  </div>
                  <div>
                    <Label>Description</Label>
                    <Textarea
                      value={newClass.description}
                      onChange={(e) => setNewClass({ ...newClass, description: e.target.value })}
                      placeholder="Class details..."
                      rows={3}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label>Date *</Label>
                      <Input
                        type="date"
                        value={newClass.date}
                        onChange={(e) => setNewClass({ ...newClass, date: e.target.value })}
                      />
                    </div>
                    <div>
                      <Label>Level</Label>
                      <Select
                        value={newClass.level}
                        onValueChange={(value) => setNewClass({ ...newClass, level: value })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="beginner">Beginner</SelectItem>
                          <SelectItem value="intermediate">Intermediate</SelectItem>
                          <SelectItem value="advanced">Advanced</SelectItem>
                          <SelectItem value="all_levels">All Levels</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label>Start Time *</Label>
                      <Input
                        type="time"
                        value={newClass.start_time}
                        onChange={(e) => setNewClass({ ...newClass, start_time: e.target.value })}
                      />
                    </div>
                    <div>
                      <Label>End Time</Label>
                      <Input
                        type="time"
                        value={newClass.end_time}
                        onChange={(e) => setNewClass({ ...newClass, end_time: e.target.value })}
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Max Students</Label>
                    <Input
                      type="number"
                      value={newClass.max_students}
                      onChange={(e) => setNewClass({ ...newClass, max_students: parseInt(e.target.value) || 20 })}
                    />
                  </div>
                  <Button
                    onClick={() => createMutation.mutate(newClass)}
                    disabled={!newClass.title || !newClass.date || !newClass.start_time || createMutation.isPending}
                    className="w-full bg-gradient-to-r from-blue-600 to-blue-700"
                  >
                    {createMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Schedule Class'}
                  </Button>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="flex justify-center py-12">
              <Loader2 className="w-8 h-8 animate-spin text-gray-400" />
            </div>
          ) : classes.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <Calendar className="w-12 h-12 mx-auto mb-3 text-gray-300" />
              <p>No classes scheduled yet</p>
            </div>
          ) : (
            <div className="space-y-4">
              {classes.map((cls) => (
                <div key={cls.id} className="p-4 bg-gradient-to-br from-blue-50 to-white rounded-xl border border-blue-100">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap mb-2">
                        <h3 className="font-semibold text-gray-900">{cls.title}</h3>
                        <Badge variant="outline" className="bg-blue-100 text-blue-800">
                          {levelLabels[cls.level]}
                        </Badge>
                      </div>
                      {cls.description && (
                        <p className="text-sm text-gray-600 mb-3">{cls.description}</p>
                      )}
                      <div className="flex flex-wrap gap-4 text-sm text-gray-500">
                        <div className="flex items-center gap-1">
                          <Calendar className="w-4 h-4" />
                          {format(new Date(cls.date), 'MMM d, yyyy')}
                        </div>
                        <div className="flex items-center gap-1">
                          <Clock className="w-4 h-4" />
                          {cls.start_time}{cls.end_time && ` - ${cls.end_time}`}
                        </div>
                        <div className="flex items-center gap-1">
                          <Users className="w-4 h-4" />
                          {cls.enrolled_students?.length || 0} / {cls.max_students} students
                        </div>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => deleteMutation.mutate(cls.id)}
                      className="text-red-500 hover:text-red-600 hover:bg-red-50"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </>
  );
}